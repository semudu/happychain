<?php
error_reporting(E_ALL);
//header('Content-Type: application/json');
ini_set('display_errors', 1);
require "suFunctions.php";

$GLOBALS['LOG_LEVELS'] = ['error','warn','info','debug'];
$GLOBALS['LOG_LEVEL'] = "info";
$GLOBALS['SEND_LIMIT'] = 3;
$GLOBALS['SEND_AMOUNT'] = 10;
$GLOBALS['SEND_WAIT_LIMIT'] = 1;

date_default_timezone_set('Europe/Istanbul');

//istekler POST olarak gÃ¶nderilmeli, Bip oyle yapiyor.
if (strcasecmp($_SERVER['REQUEST_METHOD'], 'POST') != 0) {throw new Exception('Request method must be POST!');}

//Make sure that the content type of the POST request has been set to application/json
$contentType = isset($_SERVER["CONTENT_TYPE"]) ? trim($_SERVER["CONTENT_TYPE"]) : '';

if (strcasecmp($contentType, 'application/json') != 0) {throw new Exception('Content type must be: application/json');}

//Receive the RAW post data.
$contentFromBip = trim(file_get_contents("php://input"));

//Attempt to decode the incoming RAW post data from JSON.
$decoded = json_decode($contentFromBip, true);

logr("main","debug","1request: ".$contentFromBip);

clean_buffer();
header("Connection: close\r\n");
header("Content-Encoding: none\r\n");
ignore_user_abort(true); // optional
ob_start();
echo ('Request received. Will be processed soon.');
$size = ob_get_length();
header("Content-Length: $size");
ob_end_flush(); // Strange behaviour, will not work
flush(); // Unless both are called !
clean_buffer();


//bip'ten gelen json mesajÄ± Ã§Ã¶zÃ¼mleyelim
foreach ($decoded as $key => $val) {
    //print "$key = $val\n";

    if ($key == "content") {
        $keyword = $val;
    }

    if ($key == "msgid") {
        $msgId = $val;
    }

    if ($key == "sender") {
        $sender = $val;
    }

    if ($key == "sendtime") {
        $sendtime = $val;
    }

    if ($key == "postback") {
        $postback = $val;
    }

    if ($key == "ctype") {
        $ctype = $val;
    }

    if ($key == "poll") {
        $poll = $val;
    }
}

//quick menu cevabÄ±
if (isset($postback)) {
    foreach ($postback as $key => $val) {
        if ($key == "payload") {
            $payload = $val;
            $payloadMessage = strtolower($payload);
        }
        if ($key == "postbackid") {
            $postbackID = $val;
            //$postbackID=strtolower($postbackID);
        }

    }
}

//anket cevabi
if (isset($poll)) {
    foreach ($poll as $key => $val) {
        if ($key == "optionids") {
            $optionids = $val;
            $optionPoll = $optionids[0];
        }
        if ($key == "pollid") {
            $pollIDFull = explode("-",$val);
            $pollID = $pollIDFull[0];
            $pollIDExt = sizeof($pollIDFull) > 1 ? $pollIDFull[1] : "";
        }
    }
}

//fastcgi_finish_request();

//gelen mesajÄ±n iÃ§erisini ekrana basalim
//echo "\nkeyword is: ".$keyword;
//echo "\nmsgId is: ".$msgId;
//echo "\nsender is: ".$sender;
//echo "\nsendtime id is: ".$sendtime;

$bul = array('Ã§', 'ÄŸ', 'ÅŸ', 'Ã¶', 'Ã¼', 'Ä±');
$degistir = array('c', 'g', 's', 'o', 'u', 'i');
$keyword = str_replace($bul, $degistir, isset($keyword) == true ? $keyword : "");

$wordCount = str_word_count($keyword);
//echo "\nkeyword word count: ".$wordCount;
//echo "\nkeywordLT: ".$keywordLT;
//echo "\nkeywordRT: ".$keywordRT;
//echo "\napp control result 0/1: ".$appControl;
//$appCresult=" CR: ";
//if ($appControl=0) {$appCresult="istek servis ismi icermiyor";}
//echo "\nAppcontrol array printR: ";
//print_r($appControl)." ".$appCresult;

//print_r($applist);
//echo "\napplist: ";
//print_r($applist);
$receiver = $sender;
$msisdn = substr($sender, 2, 10);
$userID = getuserIDByMSISDN($msisdn);
$publicWalletID = getWalletID($userID);
$timestamp = time();

//If json_decode failed, the JSON is invalid.
if (!is_array($decoded)) {
    throw new Exception('Received content contained invalid JSON!');
}

//$keyword=strtolower($keyword);
$keywords = explode(" ", $keyword);
$maxWordC = sizeof($keywords);
$keywordLT = strtolower($keywords[0]);
$keywordRT = $maxWordC>1 ? $keywords[1] : null;
$keywordP3 = $maxWordC>2 ? $keywords[2] : null;

for ($i = 3; $i < $maxWordC; $i++) {
    $keywordMessage = $keywordMessage . " " . $keywords[$i];
}
//$keywordMessageEncoded=base64_encode('no_message');
if (!isset($keywordMessage)) {$keywordMessage = 'jet gonderi';}
$keywordMessageEncoded = base64_encode($keywordMessage);

$komutlar = array('yolla', 'puan', 'yardim', 'liste', 'sifre', 'menu', '', '', 'pot15', 'hgx1', 'anket', 'jet', 'top5ms', 'son5giden', 'son5gelen','topres','tranco');
$commandControl = in_array($keywordLT, $komutlar);

if ($commandControl == 0) {
    $hasTransaction = hasWaitingTransaction($publicWalletID,$GLOBALS['SEND_WAIT_LIMIT']);
    if($hasTransaction == false){
        $bakiye = getIMSBalance($publicWalletID);
        if($bakiye >= $GLOBALS['SEND_AMOUNT']){
            //$content="HatalÄ± istek yaptÄ±n. YardÄ±m yazarak sihirli kelimelere eriÅŸebilirsin.";
            $tnxid = rand(1000, 20000);
            //$content=sendReceiverPollFromDB($receiver);
            $tribeID = getTribeID($userID);
            $myList = getPollReceiverlistShort($keyword, $tribeID);
            $myListCount = getPollReceiverlistCount($keyword, $tribeID);
            //$content='$myListCount: '.$myListCount.' \n $myList: '.$myList;
            if ($myList == '') {
                $content = strtoupper($keyword) . " ile baÅŸlayan alÄ±cÄ± ismi bulamadÄ±m. \n\nğŸ‘‹ğŸ»Telefonunu sallayarak hÄ±zlÄ± menÃ¼ye ulaÅŸabilirsin.\n\nYardÄ±m yazarak sihirli kelimelere ulaÅŸabilirsin. ";
            } else if ($myListCount == 1) {
                $anket = '{
                    "txnid":"' . $tnxid . '",
                    "receiver":{
                        "type":2,
                        "address": "' . $receiver . '"
                    },
                    "composition":{
                        "list":[
                        {
                            "type":13,
                            "tmmtype":2,
                            "polltmm":{
                                "title":"' . strtoupper($keywordLT) . ' ile baÅŸlayan alÄ±cÄ± isimleri aÅŸaÄŸÄ±da.",
                                "description":"Ä°smi seÃ§ip '.$GLOBALS['SEND_AMOUNT'].' IMS Yolla! \n\nğŸ‘‹ğŸ»DiÄŸer iÅŸlemler iÃ§in telefonu salla menÃ¼ gelsin. ",
                                "polltype":0,
                                "pollid":"hizlianket",
                                "image":{
                                    "url":"http://timsac.turkcell.com.tr/scontent/p2p/19022018/09/Pe336b30c03db3493052cdede73334c1b57443c13c219e3b7d70441d99add1e0d7.png",
                                    "ratio":1
                                },
                                "optionlist":[
                                {
                                    "optionid":' . $userID . ',
                                    "name":"' . getReceiverNamebyUserID($userID) . '"
                                    }' . $myList . '
                                ],
                                "buttonname":"Yolla"
                            }
                        }
                        ]
                    }
                }';
                
            } else {
                $myList = getPollReceiverlistLong($keywordLT, $tribeID);
                $anket = '{
                    "txnid":"' . $tnxid . '",
                    "receiver":{
                        "type":2,
                        "address": "' . $receiver . '"
                    },
                    "composition":{
                        "list":[
                        {
                            "type":13,
                            "tmmtype":2,
                            "polltmm":{
                                "title":"' . strtoupper($keywordLT) . ' ile baÅŸlayan alÄ±cÄ± isimleri aÅŸaÄŸÄ±da.",
                                "description":"Ä°smi seÃ§ip '.$GLOBALS['SEND_AMOUNT'].' IMS Yolla! \n\nğŸ‘‹ğŸ»DiÄŸer iÅŸlemler iÃ§in telefonu salla menÃ¼ gelsin. ",
                                "polltype":0,
                                "pollid":"hizlianket",
                                "image":{
                                    "url":"http://timsac.turkcell.com.tr/scontent/p2p/19022018/09/Pe336b30c03db3493052cdede73334c1b57443c13c219e3b7d70441d99add1e0d7.png",
                                    "ratio":1
                                },
                                "optionlist":[
                                ' . $myList . '
                                ],
                                "buttonname":"Yolla"
                            }
                        }
                        ]
                    }
                }';


                
            }
                
            $result = sendBipResponseIncReceiver($anket);
        } else {
            sendBipResponseErza($receiver, "Maalesef bakiyen yetersiz. Biraz da teÅŸekkÃ¼r almaya bak ya da Pazartesiyi bekle :)");
        }
    } else {
        sendBipResponseErza($receiver, "Ã‡ok mu sÄ±k teÅŸekkÃ¼r ediyorsun acaba :) 1 dk beklemen gerekiyor maalesef.");
    }
}

//content baslangic

//if ($keywordLT=='' && $payloadMessage=='') {

if ($ctype == 'Buzz') {
//$senderName=getNamebyPhone($msisdn);
    //wellcome message olarak kullanÄ±lÄ±t, titreÅŸim yolladÄ±ÄŸÄ±nda vs durumlarda da bu yanÄ±t dÃ¶nÃ¼lÃ¼r...
    //$content="HoÅŸgeldin ".$senderName."\n\nYardÄ±m yazarak HappyChain'de kullanabileceÄŸin komutlara ulaÅŸabilirsin.\n\n http://happychain.ga" ;
    $result = sendQuickMenu($receiver);
//$content=$result."-----".$ctype."log: ".$receiver;
}

if ($keywordLT == 'yardim' || (isset($payloadMessage) && $payloadMessage == 'yardim')) {
    $content = "Puan sorgulamak iÃ§in PUAN yaz gÃ¶nder. \n\nArkadaÅŸÄ±na puan gÃ¶ndermek iÃ§in arkadaÅŸÄ±nÄ±n isminin ilk 3-4 harfini yaz, gelen listeden seÃ§imini yap, puanÄ± gÃ¶nder.\n\nArkadaÅŸlarÄ±nÄ±n isimlerini liste halinde gÃ¶rmek iÃ§in LISTE  yaz gÃ¶nder.";
}

if ($keywordLT == 'hgx1') {
    $content = "HoÅŸgeldin " . getReceiverNamebyUserID($userID) . "\n\nğŸ‘‹ğŸ»Telefonunu sallayarak hÄ±zlÄ± menÃ¼ye ulaÅŸabilirsin.\n\nYardÄ±m yazarak sihirli kelimelere ulaÅŸabilirsin.";
}

if ($keywordLT == 'puan' || (isset($payloadMessage) && $payloadMessage == 'puan') || (isset($optionPoll) && $optionPoll == 800)) {
    $bakiye = getIMSBalance($publicWalletID);
    $totalSent = getTotalSentIsActive($publicWalletID);
    $totalReceived = getTotalReceivedIsActive($userID);
    $content = "IMS Bakiyen: " . $bakiye . " IMS\n\nGÃ¶nderdiÄŸin: ğŸ‘¼ " . $totalSent . " IMS \nSana Gelen: ğŸ™ " . $totalReceived . " IMS";
}

if ($keywordLT == 'ekle') {
    $receiverAlias = $keywordRT;
    $receiverUserID = getuserIDbyAlias($receiverAlias);
    $result = createShortcut($userID, $receiverUserID);
    $content = $receiverAlias . ' hÄ±zlÄ± gÃ¶nder listene eklendi.';
}

if ($keywordLT == 'nasil' || (isset($payloadMessage) && $payloadMessage == 'nasil')) {
//$receiverList=getReceiverList();
    $content = "TeÅŸekkÃ¼r etmek istediÄŸin biri mi var? O zaman pamuk eller cebeğŸ¤—\n
IMS transfer etmek iÃ§in teÅŸekkÃ¼r etmek istediÄŸin kiÅŸinin ilk birkaÃ§ harfini yaz ve gÃ¶nder.
\nÃ–r: ETEL ERGÃœNâ€™e IMS gÃ¶ndermek istiyorsan â€œeteâ€ yaz, yolla gelsin. ğŸ‘
\nGelen listeden arkadaÅŸÄ±nÄ±n adÄ±nÄ± bul ve yolla butonuna tÄ±kla.
\nTeÅŸekkÃ¼r etmek iÃ§in elbet bir sebebin vardÄ±r. Åimdi onu seÃ§me zamanÄ±. Gelen listeden teÅŸekkÃ¼r sebebini seÃ§ ve tekrar yolla butonuna tÄ±kla.
\nTebrikler arkadaÅŸÄ±na ".$GLOBALS['SEND_AMOUNT']." IMS yollamÄ±ÅŸ oldun, tabi eÄŸer yeterli bakiyen varsağŸ¤—";
}

if ($ctype == 'Poll' && $pollID == 'hizlianket') {
    if ($optionPoll == 900) {
        $tribeID = getTribeID($userID);
        $randomReceiver = getRandomReceiver($tribeID, $userID);
        $optionPoll = $randomReceiver;
    }
    $receiverName = getReceiverNamebyUserID($optionPoll);
    $senderName = getNamebyPhone($msisdn);
	$receiverPhone = getPhonebyUserID($optionPoll);
	
	logr("Poll","debug","msisdn: ".$msisdn.", receiverPhone: ".$receiverPhone);
	if($receiverPhone == $msisdn){
		$msg = "Kendi kendine teÅŸekkÃ¼r etmen Ã§ok hoÅŸ ama arkadaÅŸlarÄ±n da senden bir teÅŸekkÃ¼r bekliyor olabilir :)";
		sendBipResponseErza("90".$msisdn, $msg);
	}else{
		$receiverWalletID = getWalletID($optionPoll);
		$messageToSign = $receiverWalletID . $publicWalletID . $timestamp . '1000' . $GLOBALS['SEND_AMOUNT'] . '000';
		$messageBody = "\"sender\": \"" . $publicWalletID . "\",\"recipient\": \"" . $receiverWalletID . "\",
	  \"type1\": \"" . $GLOBALS['SEND_AMOUNT'] . "\",
	  \"type2\": \"0\",
	  \"type3\": \"0\",
	  \"type4\": \"0\",
	  \"amount\": \"0\",
	  \"sequence\":\"100\",
	  \"timestamp\":\"" . $timestamp . "\",
	  \"text\": \"" . $keywordMessageEncoded . "\"";

		$publicKey = getPublicKey($userID);
		$privateKey = getPrivateKey($userID);
		$signature = getSignature($publicKey, $privateKey, $messageToSign);
		$result = createTempFinRecord($msisdn, $signature, $messageBody, $receiverName, $receiverPhone);
		$optionList = getReasonOptions($optionPoll);

		$anket = '{
		 "txnid":"9999",
		 "receiver":{
			"type":2,
			"address": "' . $receiver . '"
		 },
		 "composition":{
			"list":[
			   {
				  "type":13,
				  "tmmtype":2,
				  "polltmm":{
					 "title":"' . getNameSuffix($receiverName) . ' teÅŸekkÃ¼r etmek istedin ve '.$GLOBALS['SEND_AMOUNT'].' IMS yolluyorsun.",
					 "description":"ArkadaÅŸÄ±na hangi mesajÄ± ileteyim? ",
					 "polltype":0,
					 "pollid":"reasonList",
					 "image":{
						"url":"http://timsac.turkcell.com.tr/scontent/p2p/15032018/11/Pc2de09311da2d8e88395bdacec4c53a40b8801012dc80f501c4f4e397e258b318.jpg",
						"ratio":1
					 },
					 "optionlist":'.$optionList.',
					 "buttonname":"Yolla"
				  }
			   }
			]
		 }
	  }';
	  
	  $result = sendBipResponseIncReceiver($anket);
	}

}

if ($ctype == 'Poll' && $pollID == 'hizlicevap') {
    if($optionPoll != 0){
        $hasTransaction = hasWaitingTransaction($publicWalletID,$GLOBALS['SEND_WAIT_LIMIT']);
        if($hasTransaction == false){
            $bakiye = getIMSBalance($publicWalletID);
            if($bakiye >= $GLOBALS['SEND_AMOUNT']){
                $receiverName = getReceiverNamebyUserID($optionPoll);
                $senderName = getNamebyPhone($msisdn);
                $receiverPhone = getPhonebyUserID($optionPoll);

                $receiverWalletID = getWalletID($optionPoll);
                $controlRLimit = GetReceiverLimit($publicWalletID, $receiverWalletID);
                
                if ($controlRLimit < $GLOBALS['SEND_LIMIT']) {
                    $messageToSign = $receiverWalletID . $publicWalletID . $timestamp . '1000' . $GLOBALS['SEND_AMOUNT'] . '000';
                    $messageBody = "\"sender\": \"" . $publicWalletID . "\",\"recipient\": \"" . $receiverWalletID . "\",
                    \"type1\": \"" . $GLOBALS['SEND_AMOUNT'] . "\",
                    \"type2\": \"0\",
                    \"type3\": \"0\",
                    \"type4\": \"0\",
                    \"amount\": \"0\",
                    \"sequence\":\"100\",
                    \"timestamp\":\"" . $timestamp . "\",
                    \"text\": \"" . $keywordMessageEncoded . "\"";

                        $publicKey = getPublicKey($userID);
                        $privateKey = getPrivateKey($userID);
                        $signature = getSignature($publicKey, $privateKey, $messageToSign);
                        $result = createTempFinRecord($msisdn, $signature, $messageBody, $receiverName, $receiverPhone);
                        $optionList = getReasonOptions($optionPoll);

                        $anket = '{
                        "txnid":"9999",
                        "receiver":{
                            "type":2,
                            "address": "' . $receiver . '"
                        },
                        "composition":{
                            "list":[
                            {
                                "type":13,
                                "tmmtype":2,
                                "polltmm":{
                                    "title":"' . getNameSuffix($receiverName) . ' teÅŸekkÃ¼r etmek istedin ve '.$GLOBALS['SEND_AMOUNT'].' IMS yolluyorsun.",
                                    "description":"ArkadaÅŸÄ±na hangi mesajÄ± ileteyim? ",
                                    "polltype":0,
                                    "pollid":"reasonList-hizli",
                                    "image":{
                                        "url":"http://timsac.turkcell.com.tr/scontent/p2p/15032018/11/Pc2de09311da2d8e88395bdacec4c53a40b8801012dc80f501c4f4e397e258b318.jpg",
                                        "ratio":1
                                    },
                                    "optionlist":'.$optionList.',
                                    "buttonname":"Yolla"
                                }
                            }
                            ]
                        }
                    }';
                    
                    $result = sendBipResponseIncReceiver($anket);
                } else {
                    sendBipResponseErza("90" . $msisdn, "Maalesef " . getNameSuffix($receiverName) . " bugÃ¼n 3 gÃ¶nderim yaptÄ±n. Daha fazla teÅŸekkÃ¼r iÃ§in yarÄ±nÄ± bekle :)");    
                }
            } else {
                sendBipResponseErza("90" . $msisdn, "Maalesef bakiyen yetersiz. Biraz da teÅŸekkÃ¼r almaya bak ya da Pazartesiyi bekle :)");
            }
        } else {
            sendBipResponseErza($receiver, "Ã‡ok mu sÄ±k teÅŸekkÃ¼r ediyorsun acaba :) 1 dk beklemen gerekiyor maalesef.");
        }
	} else {
		sendBipResponseErza("90" . $msisdn, "Ä°yi bakalÄ±m, bu seferlik Ã¶yle olsun :)");
	}
}

if ($ctype == 'Poll' && $pollID == 'reasonList') {
    $reason = getReason($optionPoll);
    $messageBody = getMessageBody($msisdn);
	logr("Poll","debug","messageBody: ".$messageBody);
    if (isset($messageBody)) {
        $signature = getMessageSign($msisdn);
        $publicKey = getPublicKey($userID);
        $privateKey = getPrivateKey($userID);

        $receiverPhone = getMessageReceiverPhone($msisdn);
        $receiverName = getNamebyPhone($receiverPhone);
        $receiverUserID = getuserIDByMSISDN($receiverPhone);
        $receiverWalletID = getWalletID($receiverUserID);
        $receiverBipPhone = '90' . $receiverPhone;
        $controlRLimit = GetReceiverLimit($publicWalletID, $receiverWalletID);

        $senderName = getNamebyPhone($msisdn);
		
		if ($controlRLimit < $GLOBALS['SEND_LIMIT']) {
            $resultCode = transferVcoinWithSign($messageBody, $publicKey, $signature);
            $transactionType = 'bipSendIMS';
            $happyMessage = 'bip jet: ' . $reason;
            createFinancialTransaction($msgId, $publicWalletID, $receiverWalletID, $GLOBALS['SEND_AMOUNT'], $transactionType, $resultCode, $receiverName, $optionPoll);
            //alÄ±cÄ±ya da bip mesajÄ± ile bilgi verelim.
            $receiverContent = $reason . "\n\n" . $senderName . " sana ".$GLOBALS['SEND_AMOUNT']." IMS yolladÄ± :) \n\nPuanlarÄ±n HappyChain'de kÄ±sa sÃ¼re iÃ§erisinde iÅŸlenecek ve bakiyene yansÄ±yacak.";
            $content = getNameSuffix($receiverName). "\n\n" . $reason . "\n\nmesajÄ±nÄ± da ileterek ".$GLOBALS['SEND_AMOUNT']." IMS transferini yaptÄ±k.\n\nAyrÄ±ca sen de bu gÃ¶nderimden 1 IMS kazandÄ±n.";
        } else { 
			$content =  getNameSuffix($receiverName) . " bugÃ¼n 3 gÃ¶nderim yaptÄ±n. Daha fazla teÅŸekkÃ¼r iÃ§in yarÄ±nÄ± bekle :)";
		}
	
		logr("Poll","debug","resultCode:" . $resultCode);
        if(isset($pollIDExt) && $pollIDExt=='hizli'){
            sendBipResponseErza($receiverBipPhone, $receiverContent);
        } else {
            if ($resultCode == '120') {
                $anket = '{
                    "txnid":"'.rand(1000, 20000).'",
                    "receiver":{
                        "type":2,
                        "address": "' . $receiverBipPhone . '"
                    },
                    "composition":{
                        "list":[
                        {
                            "type":13,
                            "tmmtype":2,
                            "polltmm":{
                                "title":"'.$reason . '\n\n' . $senderName . ' sana '.$GLOBALS['SEND_AMOUNT'].' IMS yolladÄ± :)",
                                "description":"Sen de ona karÅŸÄ±lÄ±k vermek ister misin? :)",
                                "polltype":0,
                                "pollid":"hizlicevap",
                                "optionlist":[{
                                        "optionid":"'. $userID .'",
                                        "name":"Yolla Gitsin"
                                    },
                                    {
                                        "optionid":"0",
                                        "name":"HayÄ±r, zaten bana borcu vardÄ±."}],
                                "buttonname":"Yolla"
                            }
                        }
                        ]
                    }
                }';
                        
                $result = sendBipResponseIncReceiver($anket);
                
            }
        }
    } else { 
		$content = 'Sebep seÃ§imini 2 dakika iÃ§inde yapmalÄ±sÄ±n. geÃ§ kaldÄ±ÄŸÄ±n iÃ§in iÅŸlemini iptal ettim. ArkadaÅŸÄ±nÄ±n ismini yazarak yeniden gÃ¶nderim baÅŸlatabilirsin.';
	}
    
}

if ($keywordLT == 'top5XX' || (isset($payloadMessage) && $payloadMessage == 'top5XX')) {
//$receiverList=getReceiverList();
    $tribeID = getTribeID($userID);
    $content = getTop5($tribeID);
}

if ($keywordLT == 'son5giden' || (isset($payloadMessage) && $payloadMessage == 'son5giden')) {
    $content = getLastSent($userID,5);
    if (!isset($content)) {$content = "HenÃ¼z gÃ¶nderim yapmadÄ±n.";}
}

if ($keywordLT == 'son5gelen' || (isset($payloadMessage) && $payloadMessage == 'son5gelen')) {
    $content = getLastReceived($userID,5);
    if (!isset($content)) {$content = "HenÃ¼z kimseden teÅŸekkÃ¼r almadÄ±n.";}
}

if ($keywordLT == 'pot15' || (isset($payloadMessage) && $payloadMessage == 'pot15')) {
//$receiverList=getReceiverList();
    $content = getTop5('2');
}

if ($keywordLT == 'tranco' || (isset($payloadMessage) && $payloadMessage == 'tranco')) {
    $content = transactionCount();
}

if ($keywordLT == 'topres' || (isset($payloadMessage) && $payloadMessage == 'topres')) {
    $content = getTopReasons();
}

if ($keywordLT == 'liste' || (isset($payloadMessage) && $payloadMessage == 'liste')) {
    $tribeID = getTribeID($userID);
    $tribeName = getTribeName($tribeID);
    $receiverList = getReceiverList($userID,$tribeID);
    $receiverList = $tribeName . " - AlÄ±cÄ± Listesi\n" . $receiverList;
	sendBipResponseErza($receiver, $receiverList);
    //$receiverList2 = getReceiverListP2($tribeID);
    //$contentP1 = $tribeName . "\n\n" . $receiverList1;
    //$content = $receiverList2;
}

if ($keywordLT == 'full' || (isset($payloadMessage) && $payloadMessage == 'full')) {
    $receiverList = getReceiverListFull($tribeID);
    $content = $receiverList;
}

if ($keywordLT == 'menu') {
    sendQuickMenu($receiver);
}

if ($keywordLT == 'anket' || (isset($payloadMessage) && $payloadMessage == 'anket')) {
    //sendReceiverPoll($receiver);
    $content = "Aktif anketim yok, olunca haber veririm.";
}

if ($keywordLT == 'jet' || (isset($payloadMessage) && $payloadMessage == 'jet')) {
    $tnxid = rand(1000, 20000);
    //$content=sendReceiverPollFromDB($receiver);
    $myList = getPollReceiverlist($userID);
    if ($myList == '') {$content = "HÄ±zlÄ± gÃ¶nder menÃ¼ne arkadaÅŸlarÄ±nÄ± eklemelisin. Liste yazarak arkadaÅŸlarÄ±nÄ±n HappyID'lerini gÃ¶r. ArdÄ±ndan \"Ekle HappyID\" yazarak arkadaÅŸÄ±nÄ± listene ekle.\n\nÃ–rnek: Ekle CIH2216";}

    $anket = '{
     "txnid":"' . $tnxid . '",
     "receiver":{
        "type":2,
        "address": "' . $receiver . '"
     },
     "composition":{
        "list":[
           {
              "type":13,
              "tmmtype":2,
              "polltmm":{
                 "title":"Hemen '.$GLOBALS['SEND_AMOUNT'].' IMS Yolla",
                 "description":"Kime gÃ¶ndermek istersin?",
                 "polltype":0,
                 "pollid":"ASDFK-2",
                 "image":{
                    "url":"http://timsac.turkcell.com.tr/scontent/p2p/19022018/09/Pe336b30c03db3493052cdede73334c1b57443c13c219e3b7d70441d99add1e0d7.png",
                    "ratio":1
                 },
                 "optionlist":[
                   {
                      "optionid":900,
                      "name":"Rasgele"
                   }' . $myList . '
                 ],
                 "buttonname":"Yolla"
              }
           }
        ]
     }
  }';

    $result = sendBipResponseIncReceiver($anket);

}

//ÅŸifre resdetleme
if ($keywordLT == 'sifre') {
    $passwd = $keywordRT;
    if ($keywordRT == '') {$content = "Åifre girmedin. Åifreni deÄŸiÅŸtirmek istiyorsan Sifre YENISIFRE yaz gÃ¶nder. \nÃ–rnek: Sifre YeniS1fr3 ";} else {
        $result = updatePassword($userID, $passwd);
        $content = "Åifreniz degistirildi.\n\nÅifren: " . $passwd . "\n\n http://happychain.ga \n\nGÃ¼venliÄŸin iÃ§in bu mesajÄ± sil. ";}
}

//manual puan transferi
if ($keywordLT == 'yolla') {
    //ikinci kelime alÄ±cÄ± bilgisi
    $receiverAlias = $keywordRT;
    $receiverName = getReceiverName($receiverAlias);
    $senderName = getNamebyPhone($msisdn);
    //Ã¼Ã§Ã¼ncÃ¼ parametre miktar
    $amount = $keywordP3;

    //geÃ§erli alÄ±cÄ± mÄ± kontrolÃ¼
    if (!isset($receiverAlias) || !isset($keywordP3)) {$content = "AlÄ±cÄ± ismini yada puan miktarÄ±nÄ± girmeyi unuttun. YardÄ±m yazarak nasÄ±l puan gÃ¶ndereceÄŸini Ã¶ÄŸrenebilirsin.";} else {
        $control = controlReceiver($receiverAlias);
        //alÄ±cÄ± geÃ§erli mi kontrol edelim
        if ($control == 1) {
            $receiverWalletID = getReceiverWalletID($receiverAlias);
            $amount = $keywordP3;
            $messageToSign = $receiverWalletID . $publicWalletID . $timestamp . '1000' . $amount . '000';
            $messageBody = "\"sender\": \"" . $publicWalletID . "\",\"recipient\": \"" . $receiverWalletID . "\",
    \"type1\": \"" . $amount . "\",
    \"type2\": \"0\",
    \"type3\": \"0\",
    \"type4\": \"0\",
    \"amount\": \"0\",
    \"sequence\":\"100\",
    \"timestamp\":\"" . $timestamp . "\",
    \"text\": \"" . $keywordMessageEncoded . "\"";

            //echo '<hr/>imzalanacak metin: '.$messageToSign;
            $publicKey = getPublicKey($userID);
            $privateKey = getPrivateKey($userID);
            //echo '<hr/><b></br> pub:</b> '.$publicKey.'</br><b> prv: </b>'.$privateKey.'</br><b> message To Be Sgined:</b> '.$messageToSign;
            $signature = getSignature($publicKey, $privateKey, $messageToSign);
            //$signature='imzaladim';
            $resultCode = transferVcoinWithSign($messageBody, $publicKey, $signature);
            $result = getResultDescription($resultCode);
            $transactionType = 'bipSendIMS';
            $happyMessage = 'bip: ' . strtoupper($receiverAlias) . " message: " . $keywordMessage;
            createFinancialTransaction($msgId, $publicWalletID, $receiverWalletID, $amount, $transactionType, $resultCode, $happyMessage, $receiverName);
            $receiverPhone = '90' . getPhonebyAlias($receiverAlias);
            //alÄ±cÄ±ya da bip mesajÄ± ile bilgi verelim.
            $receiverContent = $senderName . " sana " . number_format($amount) . " IMS yolladÄ± :) \n\nPuanlarÄ±n HappyChain'de kÄ±sa sÃ¼re iÃ§erisinde iÅŸlenecek ve bakiyene yansÄ±yacak.\n\n" . $keywordMessage . "\n\n" . $resultCode;
            //miktar sayÄ±sal deÄŸer mi kontrolÃ¼ yapalÄ±m bu da doÄŸruysa alÄ±cÄ±ya da mesaj gÃ¶nderelim.
            if ($resultCode == '120') {
				sendBipResponseErza($receiverPhone, $receiverContent);
			}
            $content =  getNameSuffix($receiverName) . " yollamak istediÄŸin miktar " . number_format($amount) . " IMS. \n\n" . $result . "\n\n" . $keywordMessage;
            //."\n\n alici msisdn: ".$receiverPhone."\n mesaj: ".$receiverContent;
        } else {
            $content = "AlÄ±cÄ±ya ait HappyID hatalÄ±. Liste yazarak arkadaÅŸlarÄ±nÄ±n HappyID'lerini gÃ¶rebilirsin.";
        }

        //gÃ¶nderilen puan geÃ§erli bir deÄŸer mi kontrol edelim. deÄŸilse hata mesajÄ± basalÄ±m
        if (!is_numeric($amount)) {$content = "GÃ¶ndermek istediÄŸiniz tutar hatalÄ±. LÃ¼tfen numerik deÄŸer giriniz.\n\n 3 IMS yollamak iÃ§in Ã¶rnek mesaj:\n\n Yolla CIH2216 3";}}
}

//content bitis

if (isset($content)) {
	$postResult = sendBipResponseErza($receiver, $content);
}

/*
if(isset($resultCode) && $resultCode === "120" ){
	sleep(4);
	$ext_content =  getNameSuffix($receiverName) . " teÅŸekkÃ¼r ettin ve 1 IMS kazandÄ±n.ğŸ‘ğŸ‘ğŸ‘\nKazandÄ±ÄŸÄ±n puan HappyChain'de transfer iÅŸlemin ile aynÄ± bloÄŸa iÅŸlenerek hesabÄ±na yansÄ±tÄ±lacak.";
	sendBipResponseErza($receiver, $ext_content);
}
*/

//date_default_timezone_set('Europe/Istanbul');
//echo "\n\nINFO - ".date('d/m/Y h:i:s', time())." - receiver is ".$receiver." and  message is:\n ".$content."\n\n";
//echo "\n\nINFO - POSTRESULT : ".date('d/m/Y h:i:s', time())." - \n".$postResult;

function sendBipResponseErza($receiver, $content)
{
    $tnxid = rand(1000, 9999);
    $postdata['txnid'] = $tnxid;
    $receiverArray['type'] = 2;
    $receiverArray['address'] = $receiver;
    $postdata['receiver'] = $receiverArray;
    $listArray0['type'] = 0;
    $listArray0['message'] = $content;
    $listArray[0] = $listArray0;
    $composition0['list'] = $listArray;
    $postdata['composition'] = $composition0;
//echo "\npostdata array: ".$postdata;
    //$postdataJson = "json=".json_encode($postdata)."&";
    $postdataJson = json_encode($postdata);
//echo "\n\npostdata json: ".$postdataJson."\n\n\n";
    $result = sendBipResponseIncReceiver($postdataJson);
	return $result;
}


function write_log($log){
	$log = $log . PHP_EOL;
	$file = "/home/serhat/dasHappyChain/log/msChainBip.log";
    file_put_contents($file, $log, FILE_APPEND | LOCK_EX);
}

function sendQuickMenu($receiver)
{
//$tnxid=rand(10000,99999);
    $postdata = '{
     "txnid":"85955",
     "receiver":{
        "type":2,
        "address": "' . $receiver . '"
     },
  "composition":{
        "list":[
           {
              "type":13,
              "tmmtype":3,
              "quickreplytmm":{
                 "postbackid":"ASDF",
                 "buttonlist":[
                    {
                       "type":"1",
                       "name":"ğŸ’° IMS Bakiyem",
                       "payload":"puan"
                    },
                    {
                         "type":"1",
                         "name":"â¡ï¸ Son YolladÄ±klarÄ±m",
                         "payload":"son5giden"
                     },
                    {
                       "type":"1",
                       "name":"â¬…ï¸ Son gelenler",
                       "payload":"son5gelen"
                    },
                    {
                       "type":"1",
                       "name":"ğŸ‘¤ğŸ‘¤ AlÄ±cÄ± Listesi",
                       "payload":"Liste"
                    },
                    {
                       "type":"1",
                       "name":"â“ NasÄ±l IMS YollarÄ±m",
                       "payload":"nasil"
                    },
    {
                     "type":"1",
                     "name":"ğŸ”® Sihirli Kelimeler",
                     "payload":"yardim"
                  	}
                 ]
              }
           }
        ]
     }
  }';

    $result = sendBipResponseIncReceiver($postdata);
//return $result."POSTDATA: ".$postdata;
    return $result;
//$content=$postdata;
}

function sendBipResponseIncReceiver($content)
{
    $bipTesURL = "http://tims.turkcell.com.tr/tes/rest/spi/sendmsgserv";
    $username = "bu2705615192872148";
    $password = "1020velo";
    $ch = curl_init($bipTesURL);
    curl_setopt($ch, CURLOPT_HEADER, true);
    curl_setopt($ch, CURLOPT_HTTPHEADER, array("Content-Type: application/json"));
    curl_setopt($ch, CURLOPT_HTTPAUTH, CURLAUTH_BASIC);
    curl_setopt($ch, CURLOPT_USERPWD, "bu2705615192872148:1020velo");
    curl_setopt($ch, CURLOPT_POSTFIELDS, $content);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_POST, true);
    $result = curl_exec($ch);
    return $result;

}

function logr($loc, $severity, $log){
	if(array_keys($GLOBALS['LOG_LEVELS'],$severity)[0] <= array_keys($GLOBALS['LOG_LEVELS'],$GLOBALS['LOG_LEVEL'])[0]){		
		$log=date("Y-m-d h:i:sa")." - HANDLER - ".$severity." - ".$loc." - ".$log . PHP_EOL;
		file_put_contents("/home/serhat/dasHappyChain/happychain.log", $log, FILE_APPEND | LOCK_EX);
	}
}

function clean_buffer(){
	if (ob_get_contents()) ob_end_clean();
}
